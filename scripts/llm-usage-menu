#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
export PATH="$HOME/.local/share/omarchy/bin:$PATH"
MENU_BIN="omarchy-launch-walker"

if ! command -v "$MENU_BIN" >/dev/null 2>&1; then
  echo "omarchy-launch-walker not found" >&2
  exit 1
fi

ensure_bun() {
  if command -v bun >/dev/null 2>&1; then
    return 0
  fi
  echo "Bun not found. Installing via Omarchy..."
  omarchy-install-dev-env bun
}

install_antigravity_usage() {
  ensure_bun
  echo "Installing antigravity-usage..."
  bun i -g antigravity-usage
}

OPTIONS=$(cat <<'EOF'
Show Details
Claude Login
Antigravity Cloud Login
Install/Update Antigravity Cloud
Reload Waybar
EOF
)

choice=$(echo "$OPTIONS" | $MENU_BIN --dmenu --width 300 --minheight 1 --maxheight 320 -p "LLM Usage" 2>/dev/null || true)

case "$choice" in
  "Show Details")
    omarchy-launch-floating-terminal-with-presentation "$SCRIPT_DIR/waybar-llm-usage.sh && echo && read -p 'Press Enter...'" ;;
  "Claude Login")
    omarchy-launch-floating-terminal-with-presentation "claude" ;;
  "Antigravity Cloud Login")
    omarchy-launch-floating-terminal-with-presentation "$SCRIPT_DIR/antigravity-waybar-usage-login" ;;
  "Install/Update Antigravity Cloud")
    omarchy-launch-floating-terminal-with-presentation "bash -lc '$(declare -f ensure_bun); $(declare -f install_antigravity_usage); install_antigravity_usage'" ;;
  "Reload Waybar")
    pkill -USR2 waybar ;;
  *)
    exit 0 ;;
esac
